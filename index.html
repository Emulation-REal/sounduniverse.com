<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ultimate Soundboard Deluxe</title>
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
      background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
      color: #eee;
      transition: background 0.4s ease, color 0.4s ease;
      position: relative;
    }
    body.dark {
      background: linear-gradient(135deg, #111 0%, #222 100%);
      color: #ccc;
    }

    /* Particle Canvas */
    #particle-canvas {
      position: fixed;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 0;
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Container */
    #app {
      position: relative;
      z-index: 10;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 15px 60px 15px;
      user-select: none;
    }

    h1 {
      text-align: center;
      font-weight: 900;
      font-size: 3rem;
      margin-bottom: 5px;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
      user-select: none;
    }

    /* Navigation Tabs */
    nav {
      display: flex;
      justify-content: center;
      gap: 18px;
      flex-wrap: wrap;
      margin-bottom: 25px;
      user-select: none;
    }
    nav button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 28px;
      border-radius: 30px;
      font-size: 1.15rem;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(52,152,219,0.6);
      transition: all 0.3s ease;
      font-weight: 700;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
    }
    nav button:hover {
      background: #2980b9;
      transform: scale(1.12);
      box-shadow: 0 8px 28px rgba(41,128,185,0.9);
    }
    nav button.active {
      background: #1abc9c;
      box-shadow: 0 10px 30px rgba(26,188,156,0.95);
      transform: scale(1.18);
    }

    /* Search Input */
    #search {
      display: block;
      margin: 0 auto 30px auto;
      padding: 15px 22px;
      width: 90%;
      max-width: 450px;
      font-size: 1.3rem;
      border: 3px solid #1abc9c;
      border-radius: 50px;
      outline: none;
      transition: border-color 0.3s ease;
      background: rgba(255 255 255 / 0.15);
      color: #eee;
      text-shadow: 0 0 3px #111;
    }
    #search:focus {
      border-color: #16a085;
      box-shadow: 0 0 18px #16a085;
      background: rgba(255 255 255 / 0.25);
      color: #fff;
    }

    /* Sound Grid */
    .sound-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      user-select: none;
    }
    .sound-button {
      background: #1abc9c;
      border-radius: 18px;
      padding: 20px 15px;
      font-weight: 700;
      color: #112;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(26,188,156,0.6);
      position: relative;
      transition: all 0.35s cubic-bezier(0.2,0,0,1);
      font-size: 1rem;
      text-align: center;
      user-select: none;
      overflow: hidden;
    }
    .sound-button:hover {
      background: #16a085;
      box-shadow: 0 14px 35px rgba(22,160,133,0.95);
      transform: translateY(-7px);
      color: #e0f7f5;
    }
    .sound-button.playing {
      animation: pulseGlow 1.3s infinite alternate;
      color: #0e3f3a;
      font-weight: 900;
      box-shadow: 0 0 20px 4px #0e3f3a inset;
    }
    @keyframes pulseGlow {
      0% {
        box-shadow: 0 0 15px 3px #0e3f3a inset;
      }
      100% {
        box-shadow: 0 0 35px 10px #0e3f3a inset;
      }
    }

    /* Favorites Button */
    .fav-btn {
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 22px;
      background: transparent;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: transform 0.25s ease;
      color: #1c2e2a;
      text-shadow: 0 0 4px #d1f2eb;
      outline-offset: 2px;
    }
    .fav-btn:hover {
      transform: scale(1.25);
      color: #16a085;
      text-shadow: 0 0 12px #16a085;
    }
    .fav-btn.favorited {
      color: #16a085;
      text-shadow: 0 0 20px #16a085;
    }

    /* Error Box */
    #error-box {
      max-width: 460px;
      margin: 15px auto 30px auto;
      padding: 14px 22px;
      background: #e74c3c;
      color: white;
      font-weight: 700;
      border-radius: 15px;
      text-align: center;
      display: none;
      user-select: none;
      box-shadow: 0 0 25px #e74c3c;
    }

    /* Settings Panel */
    #settings {
      max-width: 600px;
      margin: 0 auto 40px auto;
      background: rgba(28, 46, 42, 0.95);
      padding: 30px 36px;
      border-radius: 30px;
      box-shadow: 0 10px 28px rgba(22,160,133,0.85);
      user-select: none;
      color: #d1f2eb;
      transition: background 0.4s ease, color 0.4s ease;
    }
    body.dark #settings {
      background: rgba(40, 60, 55, 0.9);
      color: #9de8d0;
      box-shadow: 0 12px 35px rgba(26,188,156,0.9);
    }
    #settings label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      margin: 18px 0;
      font-size: 1.15rem;
      user-select: none;
    }
    #settings input[type=range] {
      width: 170px;
      cursor: pointer;
      border-radius: 10px;
    }
    #settings input[type=number] {
      width: 80px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 2px solid #16a085;
      font-weight: 700;
      font-size: 1.05rem;
      transition: border-color 0.3s ease;
      user-select: text;
      background: rgba(255 255 255 / 0.1);
      color: #c7f0e9;
      text-align: center;
    }
    #settings input[type=number]:focus {
      outline: none;
      border-color: #1abc9c;
      box-shadow: 0 0 12px #1abc9c;
      background: rgba(255 255 255 / 0.15);
    }
    #settings input[type=checkbox] {
      width: 22px;
      height: 22px;
      cursor: pointer;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));
    }

    /* Favorites List */
    #favorites-list {
      list-style: none;
      padding: 0;
      margin: 0 auto 50px auto;
      max-width: 1100px;
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(180px,1fr));
      gap: 22px;
      user-select: none;
    }
    #favorites-list li {
      list-style: none;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 14px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: #16a085;
      border-radius: 12px;
    }
    body.dark ::-webkit-scrollbar-thumb {
      background: #1abc9c;
    }

    /* Responsive */
    @media (max-width: 650px) {
      nav button {
        padding: 10px 18px;
        font-size: 1rem;
      }
      .sound-button {
        font-size: 0.9rem;
        padding: 14px 10px;
      }
      #settings label {
        font-size: 1rem;
      }
      #settings input[type=range] {
        width: 130px;
      }
      #settings input[type=number] {
        width: 60px;
        font-size: 0.9rem;
      }
    }

    /* Audio Visualizer Top-Left */
    #visualizer-container {
      position: fixed;
      top: 12px;
      left: 12px;
      width: 160px;
      height: 90px;
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
      padding: 10px 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.7);
      user-select: none;
      z-index: 20;
    }
    #visualizer-canvas {
      width: 100%;
      height: 100%;
      display: block;
      border-radius: 12px;
      background: #111a;
    }
    body.dark #visualizer-container {
      background: rgba(26,188,156,0.15);
      box-shadow: 0 0 18px #16a085aa;
    }
  </style>
</head>
<body>
  <canvas id="particle-canvas"></canvas>
  <div id="app">
    <h1>Ultimate Soundboard Deluxe</h1>
    <input
      id="search"
      type="search"
      placeholder="Search sounds..."
      aria-label="Search sounds"
      autocomplete="off"
      spellcheck="false"
    />
    <nav role="navigation" aria-label="Soundboard categories">
      <button class="tab-btn active" data-tab="all">All</button>
      <button class="tab-btn" data-tab="memes">Memes</button>
      <button class="tab-btn" data-tab="movies">Movies</button>
      <button class="tab-btn" data-tab="animals">Animals</button>
      <button class="tab-btn" data-tab="farts">Farts</button>
      <button class="tab-btn" data-tab="favorites">Favorites</button>
      <button class="tab-btn" data-tab="settings">Settings</button>
    </nav>

    <div id="error-box"></div>

    <div id="all" class="tab-content sound-grid"></div>
    <div id="memes" class="tab-content sound-grid" style="display:none;"></div>
    <div id="movies" class="tab-content sound-grid" style="display:none;"></div>
    <div id="animals" class="tab-content sound-grid" style="display:none;"></div>
    <div id="farts" class="tab-content sound-grid" style="display:none;"></div>

    <div id="favorites" class="tab-content" style="display:none;">
      <ul id="favorites-list"></ul>
    </div>

    <section id="settings" class="tab-content" style="display:none;">
      <label for="volume-control">Volume: <input type="range" id="volume-control" min="0" max="1" step="0.05" value="1" /></label>
      <label for="speed-control">Speed: <input type="range" id="speed-control" min="0.25" max="3" step="0.05" value="1" /></label>
      <label for="loop-control">Loop: <input type="checkbox" id="loop-control" /></label>
      <label for="multi-play-control">Allow multi-play: <input type="checkbox" id="multi-play-control" checked /></label>
      <label for="auto-interval-control">Auto-play interval (sec): <input type="number" id="auto-interval-control" min="0" step="1" value="0" /></label>
      <label for="dark-mode-control">Dark mode: <input type="checkbox" id="dark-mode-control" /></label>
    </section>
  </div>

  <div id="visualizer-container" aria-label="Audio visualizer" role="img" aria-live="polite">
    <canvas id="visualizer-canvas" width="160" height="90"></canvas>
  </div>

  <script>
    (() => {
      // --- SOUNDS DATA ---
      // URLs from free sources or CDN, mostly short mp3 clips from public domain or CC0
      const sounds = [
        // Memes
        { name: "Vine 'What are those?'", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/vine-what-are-those.mp3", category: "memes" },
        { name: "Airhorn", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/airhorn.mp3", category: "memes" },
        { name: "Sad Trombone", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/sad-trombone.mp3", category: "memes" },
        { name: "Bruh Sound Effect", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/bruh.mp3", category: "memes" },
        { name: "Record Scratch", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/record-scratch.mp3", category: "memes" },
        { name: "Fart Noise", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/fart-1.mp3", category: "farts" },
        { name: "Fart Wet", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/fart-wet.mp3", category: "farts" },

        // Movies
        { name: "Lightsaber Swing", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/lightsaber-swing.mp3", category: "movies" },
        { name: "R2D2 Beep", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/r2d2-beep.mp3", category: "movies" },
        { name: "Indiana Jones Whip", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/indy-whip.mp3", category: "movies" },
        { name: "Jaws Theme", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/jaws-theme.mp3", category: "movies" },

        // Animals
        { name: "Dog Bark", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/dog-bark.mp3", category: "animals" },
        { name: "Cat Meow", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/cat-meow.mp3", category: "animals" },
        { name: "Cow Moo", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/cow-moo.mp3", category: "animals" },
        { name: "Lion Roar", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/lion-roar.mp3", category: "animals" },
        { name: "Elephant Trumpet", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/elephant-trumpet.mp3", category: "animals" },

        // Farts (few)
        { name: "Classic Fart", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/classic-fart.mp3", category: "farts" },
        { name: "Sneaky Fart", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/sneaky-fart.mp3", category: "farts" },
        { name: "Squeaky Fart", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/squeaky-fart.mp3", category: "farts" },
        { name: "Long Fart", url: "https://cdn.jsdelivr.net/gh/emulation12/sounds/long-fart.mp3", category: "farts" },

        // Add more sounds here with diverse URLs or self-hosted ones if you want
      ];

      // --- GLOBALS & DOM ---
      const tabs = document.querySelectorAll('nav button.tab-btn');
      const contents = document.querySelectorAll('.tab-content');
      const searchInput = document.getElementById('search');
      const errorBox = document.getElementById('error-box');

      const allContainer = document.getElementById('all');
      const memesContainer = document.getElementById('memes');
      const moviesContainer = document.getElementById('movies');
      const animalsContainer = document.getElementById('animals');
      const fartsContainer = document.getElementById('farts');
      const favoritesContainer = document.getElementById('favorites-list');

      // Settings controls
      const volumeControl = document.getElementById('volume-control');
      const speedControl = document.getElementById('speed-control');
      const loopControl = document.getElementById('loop-control');
      const multiPlayControl = document.getElementById('multi-play-control');
      const autoIntervalControl = document.getElementById('auto-interval-control');
      const darkModeControl = document.getElementById('dark-mode-control');

      // Audio
      let audioContext = null;
      let analyser = null;
      let audioSource = null;
      let currentAudios = [];
      let autoPlayIntervalId = null;

      // Favorites loaded from localStorage
      let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

      // --- FUNCTIONS ---

      // Tab switching
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          contents.forEach(c => (c.style.display = 'none'));
          const selected = document.getElementById(tab.dataset.tab);
          if (selected) selected.style.display = 'grid' || 'block';
          if(tab.dataset.tab === 'favorites') {
            renderFavorites();
          }
          if(tab.dataset.tab === 'settings') {
            // nothing special
          }
        });
      });

      // Create sound button with favorite toggle
      function createSoundButton(sound) {
        const btn = document.createElement('button');
        btn.className = 'sound-button';
        btn.textContent = sound.name;
        btn.title = `Play "${sound.name}"`;
        btn.tabIndex = 0;

        // Favorite Button
        const favBtn = document.createElement('button');
        favBtn.className = 'fav-btn';
        const isFav = favorites.includes(sound.url);
        favBtn.innerHTML = isFav ? 'â¤ï¸' : 'ðŸ¤';
        if(isFav) favBtn.classList.add('favorited');
        favBtn.title = isFav ? 'Remove from favorites' : 'Add to favorites';

        favBtn.addEventListener('click', e => {
          e.stopPropagation();
          toggleFavorite(sound.url, favBtn);
        });

        btn.appendChild(favBtn);
        btn.addEventListener('click', () => playSound(sound, btn));
        return btn;
      }

      // Render all sounds filtered by search term
      function renderSounds(filter = '') {
        [allContainer, memesContainer, moviesContainer, animalsContainer, fartsContainer].forEach(container => (container.innerHTML = ''));

        // For "all", show every sound in the allContainer
        sounds.forEach(sound => {
          if (!sound.name.toLowerCase().includes(filter.toLowerCase())) return;
          const btn = createSoundButton(sound);
          // Add to allContainer always
          allContainer.appendChild(btn);

          // Add to category containers
          switch(sound.category) {
            case 'memes': memesContainer.appendChild(createSoundButton(sound)); break;
            case 'movies': moviesContainer.appendChild(createSoundButton(sound)); break;
            case 'animals': animalsContainer.appendChild(createSoundButton(sound)); break;
            case 'farts': fartsContainer.appendChild(createSoundButton(sound)); break;
          }
        });
      }

      // Render favorites tab
      function renderFavorites() {
        favoritesContainer.innerHTML = '';
        if (favorites.length === 0) {
          const p = document.createElement('p');
          p.textContent = "No favorites yet! Click the â¤ï¸ on a sound to add it here.";
          p.style.fontStyle = 'italic';
          p.style.textAlign = 'center';
          p.style.gridColumn = '1 / -1';
          favoritesContainer.appendChild(p);
          return;
        }
        favorites.forEach(url => {
          const sound = sounds.find(s => s.url === url);
          if(sound) {
            const li = document.createElement('li');
            li.appendChild(createSoundButton(sound));
            favoritesContainer.appendChild(li);
          }
        });
      }

      // Toggle favorite state & persist
      function toggleFavorite(url, favBtn) {
        const idx = favorites.indexOf(url);
        if (idx === -1) {
          favorites.push(url);
          favBtn.innerHTML = 'â¤ï¸';
          favBtn.classList.add('favorited');
          favBtn.title = 'Remove from favorites';
        } else {
          favorites.splice(idx, 1);
          favBtn.innerHTML = 'ðŸ¤';
          favBtn.classList.remove('favorited');
          favBtn.title = 'Add to favorites';
        }
        localStorage.setItem('favorites', JSON.stringify(favorites));
      }

      // Play a sound with Web Audio and setup visualizer
      function playSound(sound, button) {
        errorBox.style.display = 'none';

        if (!audioContext) {
          audioContext = new AudioContext();
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 256;
          analyser.smoothingTimeConstant = 0.7;
        }

        if (!multiPlayControl.checked) {
          currentAudios.forEach(aud => {
            try { aud.pause(); } catch { }
          });
          currentAudios.length = 0;
          if (audioSource) audioSource.disconnect();
        }

        // Fetch and decode the audio buffer to connect to Web Audio API
        fetch(sound.url)
          .then(response => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.arrayBuffer();
          })
          .then(buffer => audioContext.decodeAudioData(buffer))
          .then(decodedData => {
            const source = audioContext.createBufferSource();
            source.buffer = decodedData;
            source.playbackRate.value = parseFloat(speedControl.value);
            source.loop = loopControl.checked;

            // Connect source -> analyser -> destination
            source.connect(analyser);
            analyser.connect(audioContext.destination);

            source.start(0);

            currentAudios.push(source);
            audioSource = source;

            if(button) {
              button.classList.add('playing');
              setTimeout(() => button.classList.remove('playing'), 1500);
            }
          })
          .catch(() => {
            errorBox.textContent = `Failed to load audio: ${sound.name}`;
            errorBox.style.display = 'block';
          });
      }

      // Audio Visualizer
      const visualizerCanvas = document.getElementById('visualizer-canvas');
      const visualizerCtx = visualizerCanvas.getContext('2d');
      const visualizerWidth = visualizerCanvas.width;
      const visualizerHeight = visualizerCanvas.height;

      function drawVisualizer() {
        if (!analyser) {
          visualizerCtx.clearRect(0, 0, visualizerWidth, visualizerHeight);
          requestAnimationFrame(drawVisualizer);
          return;
        }

        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);

        visualizerCtx.clearRect(0, 0, visualizerWidth, visualizerHeight);
        const barWidth = (visualizerWidth / bufferLength) * 2.5;
        let x = 0;
        for(let i = 0; i < bufferLength; i++) {
          const barHeight = (dataArray[i] / 255) * visualizerHeight;
          const r = 30 + (barHeight / visualizerHeight) * 200;
          const g = 200 - (barHeight / visualizerHeight) * 180;
          const b = 150;
          visualizerCtx.fillStyle = `rgb(${r},${g},${b})`;
          visualizerCtx.fillRect(x, visualizerHeight - barHeight, barWidth, barHeight);
          x += barWidth + 1;
        }

        requestAnimationFrame(drawVisualizer);
      }

      // Search filtering event
      searchInput.addEventListener('input', e => {
        renderSounds(e.target.value.trim());
      });

      // Settings persistence
      function loadSettings() {
        const vol = localStorage.getItem('volume');
        if(vol !== null) volumeControl.value = vol;

        const spd = localStorage.getItem('speed');
        if(spd !== null) speedControl.value = spd;

        const looped = localStorage.getItem('loop');
        if(looped !== null) loopControl.checked = looped === 'true';

        const multi = localStorage.getItem('multiPlay');
        if(multi !== null) multiPlayControl.checked = multi === 'true';

        const autoInt = localStorage.getItem('autoInterval');
        if(autoInt !== null) autoIntervalControl.value = autoInt;

        const dark = localStorage.getItem('darkMode');
        if(dark !== null) {
          darkModeControl.checked = dark === 'true';
          updateDarkMode(darkModeControl.checked);
        }
      }
      function saveSettings() {
        localStorage.setItem('volume', volumeControl.value);
        localStorage.setItem('speed', speedControl.value);
        localStorage.setItem('loop', loopControl.checked);
        localStorage.setItem('multiPlay', multiPlayControl.checked);
        localStorage.setItem('autoInterval', autoIntervalControl.value);
        localStorage.setItem('darkMode', darkModeControl.checked);
      }

      // Dark Mode toggle
      function updateDarkMode(enabled) {
        if(enabled) document.body.classList.add('dark');
        else document.body.classList.remove('dark');
      }
      darkModeControl.addEventListener('change', e => {
        updateDarkMode(e.target.checked);
        saveSettings();
      });

      // Settings event listeners
      volumeControl.addEventListener('input', saveSettings);
      speedControl.addEventListener('input', saveSettings);
      loopControl.addEventListener('change', saveSettings);
      multiPlayControl.addEventListener('change', saveSettings);
      autoIntervalControl.addEventListener('input', saveSettings);

      // Autoplay handler
      function startAutoPlay() {
        if (autoPlayIntervalId) clearInterval(autoPlayIntervalId);
        const intervalSec = Number(autoIntervalControl.value);
        if (intervalSec > 0) {
          let index = 0;
          autoPlayIntervalId = setInterval(() => {
            if(sounds.length === 0) return;
            const sound = sounds[index % sounds.length];
            playSound(sound);
            index++;
          }, intervalSec * 1000);
        }
      }
      autoIntervalControl.addEventListener('change', () => {
        startAutoPlay();
        saveSettings();
      });

      // PARTICLES BACKGROUND

      const canvas = document.getElementById('particle-canvas');
      const ctx = canvas.getContext('2d');
      let w, h;
      let particles = [];
      const PARTICLE_COUNT = 90;
      const MAX_DISTANCE = 130;

      function initCanvas() {
        w = window.innerWidth;
        h = window.innerHeight;
        canvas.width = w;
        canvas.height = h;
      }

      class Particle {
        constructor() {
          this.x = Math.random() * w;
          this.y = Math.random() * h;
          this.vx = (Math.random() - 0.5) * 0.8;
          this.vy = (Math.random() - 0.5) * 0.8;
          this.radius = 2.3 + Math.random() * 1.7;
        }
        update() {
          this.x += this.vx;
          this.y += this.vy;

          if (this.x < 0 || this.x > w) this.vx *= -1;
          if (this.y < 0 || this.y > h) this.vy *= -1;
        }
        draw() {
          ctx.beginPath();
          ctx.fillStyle = 'rgba(255, 255, 255, 0.22)';
          ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
          ctx.shadowBlur = 3;
          ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      function connectParticles() {
        for(let i=0; i < particles.length; i++) {
          for(let j=i+1; j < particles.length; j++) {
            const p1 = particles[i];
            const p2 = particles[j];
            const dx = p1.x - p2.x;
            const dy = p1.y - p2.y;
            const dist = Math.sqrt(dx*dx + dy*dy);

            if(dist < MAX_DISTANCE) {
              ctx.beginPath();
              ctx.strokeStyle = `rgba(255, 255, 255, ${(MAX_DISTANCE - dist) / MAX_DISTANCE * 0.3})`;
              ctx.lineWidth = 1.2;
              ctx.moveTo(p1.x, p1.y);
              ctx.lineTo(p2.x, p2.y);
              ctx.stroke();
            }
          }
        }
      }

      function animateParticles() {
        ctx.clearRect(0, 0, w, h);
        particles.forEach(p => {
          p.update();
          p.draw();
        });
        connectParticles();
        requestAnimationFrame(animateParticles);
      }

      window.addEventListener('resize', () => {
        initCanvas();
        particles = [];
        for(let i=0; i < PARTICLE_COUNT; i++) {
          particles.push(new Particle());
        }
      });

      // Initialize everything
      function init() {
        initCanvas();
        for(let i=0; i < PARTICLE_COUNT; i++) {
          particles.push(new Particle());
        }
        animateParticles();
        loadSettings();
        renderSounds();
        startAutoPlay();
        drawVisualizer();
      }

      // Kick off init
      window.onload = init;

    })();
  </script>
</body>
</html>
